<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard M√©dico - Sistema de Monitoreo de Salud</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #009688 0%, #00796b 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5em;
      font-weight: bold;
    }

    .user-details h2 {
      margin: 0;
      color: #333;
      font-size: 1.3em;
    }

    .user-details p {
      margin: 5px 0 0 0;
      color: #666;
      font-size: 0.9em;
    }

    .btn-logout {
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .search-panel {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 25px;
      margin-bottom: 20px;
    }

    .search-panel h3 {
      margin: 0 0 20px 0;
      color: #009688;
    }

    .search-options {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-option {
      flex: 1;
      min-width: 250px;
    }

    .search-option label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .search-box {
      display: flex;
      gap: 10px;
    }

    .search-box input,
    .search-box select {
      flex: 1;
      padding: 12px;
      border: 2px solid #009688;
      border-radius: 8px;
      font-size: 1em;
    }

    .search-box button {
      padding: 12px 30px;
      background: #009688;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .search-box button:hover {
      background: #00796b;
      transform: translateY(-2px);
    }

    .patient-list {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .patient-item {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .patient-item:hover {
      background: #e0f2f1;
      transform: translateX(5px);
    }

    .patient-item.selected {
      background: #009688;
      color: white;
    }

    #current-patient {
      background: #e0f2f1;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      color: #00796b;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info">
        <div class="user-avatar">üë®‚Äç‚öïÔ∏è</div>
        <div class="user-details">
          <h2>{{ user.nombre }}</h2>
          <p>ü©∫ {{ user.especialidad }} | üë®‚Äç‚öïÔ∏è M√©dico</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-logout" onclick="window.location.href='/logout'">
          üö™ Cerrar Sesi√≥n
        </button>
      </div>
    </div>

    <h1>ü©∫ Panel de Monitoreo M√©dico</h1>

    <!-- üîç Panel de b√∫squeda -->
    <div class="search-panel">
      <h3>Buscar Paciente</h3>
      <div class="search-options">
        <div class="search-option">
          <label>Por C√©dula:</label>
          <div class="search-box">
            <input 
              type="text" 
              id="cedula-input" 
              placeholder="Ej: 123456789"
              pattern="[0-9]*"
            />
            <button id="search-btn">Buscar üîç</button>
          </div>
        </div>
        <div class="search-option">
          <label>Lista de Pacientes:</label>
          <button id="load-patients-btn" class="search-box" style="justify-content: center;">
            Cargar Pacientes üìã
          </button>
        </div>
      </div>
      
      <div id="patient-list-container" class="hidden">
        <label><strong>Seleccione un paciente:</strong></label>
        <div id="patient-list" class="patient-list"></div>
      </div>

      <div id="current-patient" class="hidden">
        <strong>üë§ Paciente Actual:</strong> <span id="patient-name"></span> - 
        <strong>üìã C√©dula:</strong> <span id="patient-cedula"></span>
      </div>
    </div>

    <!-- üîî Panel de alertas -->
    <div id="alert-panel" class="alert hidden">
      <strong>‚ö†Ô∏è Alerta:</strong> <span id="alert-message"></span>
    </div>

    <!-- üìä Mensaje de estado -->
    <div id="status-message" class="status-message hidden">
      <span id="status-text"></span>
    </div>

    <!-- üìà Gr√°ficas -->
    <div class="cards">
      <div class="card">
        <h3>Ritmo Card√≠aco ‚ù§Ô∏è</h3>
        <canvas id="bpmChart"></canvas>
        <div class="chart-info">
          <span>√öltimo: <strong id="last-bpm">--</strong> BPM</span>
        </div>
      </div>
      <div class="card">
        <h3>Temperatura üå°Ô∏è</h3>
        <canvas id="tempChart"></canvas>
        <div class="chart-info">
          <span>√öltima: <strong id="last-temp">--</strong> ¬∞C</span>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  <script>
    const loadPatientsBtn = document.getElementById('load-patients-btn');
    const patientListContainer = document.getElementById('patient-list-container');
    const patientList = document.getElementById('patient-list');
    const currentPatient = document.getElementById('current-patient');
    const patientName = document.getElementById('patient-name');
    const patientCedulaDisplay = document.getElementById('patient-cedula');

    loadPatientsBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/pacientes');
        const pacientes = await res.json();

        if (pacientes && pacientes.length > 0) {
          patientList.innerHTML = '';
          pacientes.forEach(p => {
            const item = document.createElement('div');
            item.className = 'patient-item';
            item.innerHTML = `
              <span><strong>${p.nombre}</strong></span>
              <span>üìã ${p.cedula}</span>
            `;
            item.addEventListener('click', () => {
              document.querySelectorAll('.patient-item').forEach(i => i.classList.remove('selected'));
              item.classList.add('selected');
              startMonitoring(p.cedula, p.nombre);
            });
            patientList.appendChild(item);
          });
          patientListContainer.classList.remove('hidden');
          showStatus(`${pacientes.length} pacientes encontrados`);
        } else {
          showStatus('No hay pacientes registrados', true);
        }
      } catch (error) {
        showStatus('Error al cargar pacientes', true);
      }
    });

    function startMonitoring(cedula, nombre) {
      currentCedula = cedula;
      patientName.textContent = nombre || 'Desconocido';
      patientCedulaDisplay.textContent = cedula;
      currentPatient.classList.remove('hidden');
      
      if (updateInterval) clearInterval(updateInterval);
      updateCharts();
      updateInterval = setInterval(updateCharts, 5000);
    }
  </script>
</body>
</html>